/*
 * znptest.c
 *
 *  Created on: Jul 23, 2017
 *      Author: kon
 */


#include "stdio.h"
#include "stdlib.h"
#include <fcntl.h>
#include <termios.h>
#include "ktype.h"

#define znp_dev_path "/dev/ttyACM0"

u8 zb_start_req[3] = {0x00,0x26,0x00};

static int openSerial(char *cSerialName);

int main(void)
 {
 pthread_t thread;
 int status ;

  int s_fd = openSerial(znp_dev_path);
  if(s_fd > 0)
   {
	/** create thread 1 **/
	status = pthread_create(&thread, NULL, ListeningUsart, (void*)file_t);
   }

  if(s_fd > 0)
   {
    printf("device open success!\n");
    znp_dev_pack(zb_start_req, sizeof(zb_start_req), s_fd);
   }

  printf("znptest processor start !\n");

  pthread_join(&thread, NULL);
  return 0;
 }

/*****************************************************************************
  open sriral port
  return: the file of port
 *****************************************************************************/
static int openSerial(char *cSerialName)
{
    int iFd;

    struct termios opt;

    iFd = open(cSerialName, O_RDWR | O_NOCTTY);
    if(iFd < 0) {
        perror(cSerialName);
        return -1;
    }

    tcgetattr(iFd, &opt);
    //cfsetispeed(&opt, B57600);
    //cfsetospeed(&opt, B57600);

     cfsetispeed(&opt, B115200);
     cfsetospeed(&opt, B115200);


    /*
     * raw mode
     */
    opt.c_lflag   &=   ~(ECHO   |   ICANON   |   IEXTEN   |   ISIG);
    opt.c_iflag   &=   ~(BRKINT   |   ICRNL   |   INPCK   |   ISTRIP   |   IXON);
    opt.c_oflag   &=   ~(OPOST);
    opt.c_cflag   &=   ~(CSIZE   |   PARENB);
    opt.c_cflag   |=   CS8;

    /*
     * 'DATA_LEN' bytes can be read by serial
     */
    opt.c_cc[VMIN]   =   1;//
    opt.c_cc[VTIME]  =   1;//wait time for reading once

    if (tcsetattr(iFd,   TCSANOW,   &opt)<0) {
        return   -1;
    }


    return iFd;
}
/*
 * ListeningUsart
 */
void *ListeningUsart(void *serial_fd)
 {
   int ser_fd = (long)serial_fd;
   printf("thread start");
   fd_set readfds;
   struct timeval tv;
   tv.tv_sec = 0;
   tv.tv_usec = 100000;//100ms
  /**whe**/

	printf("thread_file_id= %d",ser_fd);
	while(1)
	{
		//pthread_mutex_lock(&uart_mutex);
		FD_ZERO(&readfds);
		FD_SET(ser_fd, &readfds);
		int ret = select(ser_fd + 1, &readfds, NULL, NULL, &tv);
		if (ret > 0)
		{

			//	sleep(1);
			/* read MAX_READ_SIZE bytes data value from serial port */
			int read_len = read(ser_fd, rxbuf, 10);

			if (read_len > 0)
			{
				for (unsigned char i = 0; i < read_len; i++)
				{

					printf("%X", rxbuf[i]); //print the rx message from child thread

				}
				printf("\nread_len = %d\n", read_len);
				ProcessRxMsg(rxbuf, read_len);
			}
		}
		//pthread_mutex_unlock(&uart_mutex);

	}
 pthread_exit(NULL);

 }
